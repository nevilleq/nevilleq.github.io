<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Quinton Neville">
<meta name="dcterms.date" content="2023-02-14">

<title>Quinton Neville - Introduction to SQL for R Users w/Examples</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Quinton Neville</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../qn_resume.html" rel="" target="">
 <span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-advanced-data-science-in-r" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Advanced Data Science in R</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-advanced-data-science-in-r">    
        <li>
    <a class="dropdown-item" href="../../pubh_7462/syllabus.html" rel="" target="">
 <span class="dropdown-text">PUBH 7462 Advanced <code>R</code> Syllabus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../pubh_7462/final_projects.html" rel="" target="">
 <span class="dropdown-text"><code>Students' Final Project Website Showcase!</code></span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://nevilleq.shinyapps.io/nyc_airbnb_shiny_dashboard_leaflet/" rel="" target="">
 <span class="dropdown-text">NYC Airbnb <code>shiny</code> <code>flexdashboard</code> Example</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../pubh_7462/lecture_week_7/flexdashboard_activity_solution.html" rel="" target="">
 <span class="dropdown-text">NYC Airbnb <code>flexdashboard</code> Example</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../pubh_7462/lecture_week_4/lecture_week_4.Rmd" rel="" target="">
 <span class="dropdown-text">Lecture: Data Visualization (<code>ggplot2</code>, <code>gt</code>)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../pubh_7462/lecture_week_7/lecture_week_7.Rmd" rel="" target="">
 <span class="dropdown-text">Lecture: Interactive Plots, Tables &amp; Dashboards</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../pubh_7462/lecture_quarto_websites/quarto_websites.html" rel="" target="">
 <span class="dropdown-text">Lecture: R Websites with Quarto &amp; Github</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../pubh_7462/lecture_sqlr/dbplyr_sql.html" rel="" target="">
 <span class="dropdown-text">Lecture: Intro to SQL for R Users</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../pubh_7462/lecture_week_11/lecture_week_11.nb.html" rel="" target="">
 <span class="dropdown-text">Lecture: Advanced Spatial Mapping</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../pubh_7462/lecture_week_12/lecture_week_12.Rmd" rel="" target="">
 <span class="dropdown-text">Lecture: Git Collaboration &amp; Intro to <code>shiny</code></span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../pubh_7462/lecture_week_14/lecture_week_14.Rmd" rel="" target="">
 <span class="dropdown-text">Lecture: <code>shiny</code> Apps &amp; Dashboards</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-biostatistics" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Biostatistics</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-biostatistics">    
        <li>
    <a class="dropdown-item" href="https://nevilleq.github.io/bayesRCM/" rel="" target="">
 <span class="dropdown-text">Bayesian Robust Random Covariance Model (RCM)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://docs.google.com/presentation/d/1andU17E2c4d0fsUdMi3aWm1-B1P7Fm-QqzXcEXmNA9Q/edit?usp=sharing" rel="" target="">
 <span class="dropdown-text">RCM Task-based fMRI Study of Adolescent Depression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://arxiv.org/abs/2108.05034" rel="" target="">
 <span class="dropdown-text">Bayesian Functional Graphical Model</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../old_work/ml_theory.html" rel="" target="">
 <span class="dropdown-text">ML-Boosting SNP Classification</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../old_work/stat_gen.html" rel="" target="">
 <span class="dropdown-text">TCGA Differential Methylation in Kidney Cancer</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-data-science-for-the-public-good" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Data Science for the Public Good</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-data-science-for-the-public-good">    
        <li>
    <a class="dropdown-item" href="../../old_work/dspg_overview.html" rel="" target="">
 <span class="dropdown-text">DSPG Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../old_work/fairfax.html" rel="" target="">
 <span class="dropdown-text">Geospatial Composite Index</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../old_work/business_innovation.html" rel="" target="">
 <span class="dropdown-text">Innovation &amp; ML Text Classification</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../old_work/dog_bites.html" rel="" target="">
 <span class="dropdown-text">Dog Bites in NYC</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="http://github.com/nevilleq/" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/quinton-neville/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:nevil066@umn.edu" rel="" target=""><i class="bi bi-envelope" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul class="collapse">
  <li><a href="#intro-to-sql" id="toc-intro-to-sql" class="nav-link active" data-scroll-target="#intro-to-sql">1. Intro to SQL</a>
  <ul class="collapse">
  <li><a href="#order-of-execution-neq-syntax-order-of-sql-procedures" id="toc-order-of-execution-neq-syntax-order-of-sql-procedures" class="nav-link" data-scroll-target="#order-of-execution-neq-syntax-order-of-sql-procedures">1.1 Order of Execution <span class="math inline">\(\neq\)</span> Syntax Order of SQL Procedures</a></li>
  <li><a href="#derived-tables" id="toc-derived-tables" class="nav-link" data-scroll-target="#derived-tables">1.2 Derived Tables</a></li>
  <li><a href="#sub-queries" id="toc-sub-queries" class="nav-link" data-scroll-target="#sub-queries">1.3 Sub-queries</a></li>
  </ul></li>
  <li><a href="#but-what-is-a-structured-query-language" id="toc-but-what-is-a-structured-query-language" class="nav-link" data-scroll-target="#but-what-is-a-structured-query-language">2. But what <em>is</em> a Structured Query Language?</a></li>
  <li><a href="#how-to-use-dbi-to-connect-to-db-and-dbplyr-to-generate-queries" id="toc-how-to-use-dbi-to-connect-to-db-and-dbplyr-to-generate-queries" class="nav-link" data-scroll-target="#how-to-use-dbi-to-connect-to-db-and-dbplyr-to-generate-queries">3. How to use <code>DBI</code> to connect to db and <code>dbplyr</code> to generate queries</a></li>
  <li><a href="#lets-wrangle-some-data-examples-wexplanation" id="toc-lets-wrangle-some-data-examples-wexplanation" class="nav-link" data-scroll-target="#lets-wrangle-some-data-examples-wexplanation">4. Let’s Wrangle Some Data! (Examples w/Explanation)</a>
  <ul class="collapse">
  <li><a href="#nyc-flights-basic-grouped-summary-stats-sqlite" id="toc-nyc-flights-basic-grouped-summary-stats-sqlite" class="nav-link" data-scroll-target="#nyc-flights-basic-grouped-summary-stats-sqlite">4.1 NYC Flights ‘basic’ grouped summary stats (SQLite)</a></li>
  <li><a href="#filtering-by-the-max-and-min-city-name-by-string-length-mysql" id="toc-filtering-by-the-max-and-min-city-name-by-string-length-mysql" class="nav-link" data-scroll-target="#filtering-by-the-max-and-min-city-name-by-string-length-mysql">4.2 Filtering by the max and min city name, by string length (MySQL)</a></li>
  <li><a href="#more-complex-group_by-summarise-in-mysql" id="toc-more-complex-group_by-summarise-in-mysql" class="nav-link" data-scroll-target="#more-complex-group_by-summarise-in-mysql">4.3 More complex group_by + summarise in (MySQL)</a></li>
  <li><a href="#simple-regex-queries-makes-me-miss-stringr-mysql" id="toc-simple-regex-queries-makes-me-miss-stringr-mysql" class="nav-link" data-scroll-target="#simple-regex-queries-makes-me-miss-stringr-mysql">4.4 Simple regex queries, makes me miss <code>stringr</code>! (MySQL)</a></li>
  <li><a href="#table-joins-on-table-joins-mysql" id="toc-table-joins-on-table-joins-mysql" class="nav-link" data-scroll-target="#table-joins-on-table-joins-mysql">4.6 Table Joins on Table Joins (MySQL)</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Introduction to SQL for R Users w/Examples</h1>
<p class="subtitle lead">SQL - <em>Structured Query Language</em></p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Quinton Neville </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 14, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>First and foremost, unlike <code>R</code>, SQL is a <em>procedural language</em> in that it is quite literally an ordered list of instructions or procedures for a computer to follow. It’s also a language that operates on <em>tabular data</em>, which in a not so technical way can be described as any data you can feasibly put into an Excel spreadsheet. Being procedural does make the language less flexible in many ways, but the trade-off in increased speed, efficiency, and ability to wrangle data without bringing it all into active memory is truly astounding – hence why it’s still around today!</p>
<section id="resources-for-todays-lecture" class="level3">
<h3 class="anchored" data-anchor-id="resources-for-todays-lecture">Resources for Today’s Lecture</h3>
<p>This lecture is by no means comprehensive and is just meant to serve as an introduction for those with an intermediate level of <code>R</code> and <code>tidyverse</code> knowledge. To that end, here are a list of resources from today’s lecture for more in-depth explanations and examples by people who are much smarter than me, as well as resources for the core <code>R</code> packages implemented in the examples.</p>
<section id="sql-resources" class="level4">
<h4 class="anchored" data-anchor-id="sql-resources">SQL Resources</h4>
<ul>
<li><a href="https://blog.jooq.org/10-easy-steps-to-a-complete-understanding-of-sql/">10 Steps to Understanding SQL</a> (<strong>Highly Recommended</strong>)</li>
<li><a href="https://www.techtarget.com/searchdatamanagement/definition/SQL#:~:text=Structured%20Query%20Language%20(SQL)%20is,on%20the%20data%20in%20them.">SQL Explained</a> (<strong>Highly Recommended</strong>)</li>
<li><a href="https://www.codecademy.com/learn/learn-sql">Code Academy SQL</a></li>
<li><a href="https://www.sqlite.org/queryplanner.html">Indexes &amp; Planning Queries with SQLite</a></li>
<li><a href="https://en.wikipedia.org/wiki/SQL">SQL Wikipedia</a>
<ul>
<li>More on the origins of SQL, relational databases, etc. (actually a decent read)</li>
</ul></li>
</ul>
</section>
<section id="r-package-vignettes" class="level4">
<h4 class="anchored" data-anchor-id="r-package-vignettes">R Package Vignettes</h4>
<ul>
<li><a href="https://dplyr.tidyverse.org/"><code>dplyr</code></a></li>
<li><a href="https://dbplyr.tidyverse.org/"><code>dbplyr</code></a></li>
<li><a href="https://shiny.rstudio.com/articles/pool-basics.html"><code>pool</code></a></li>
<li><a href="https://cran.r-project.org/web/packages/RMySQL/RMySQL.pdf"><code>RMySQL</code></a></li>
<li><a href="https://cran.r-project.org/web/packages/RSQLite/vignettes/RSQLite.html"><code>RSQLite</code></a></li>
</ul>
<p><em>Note</em> – Personally, I find SQLite is easier to work with, RSQLite is better maintained, and Rstudio developers seem to prefer both as well. <strong>However</strong> coding assessment websites may not support SQLite, but seem to support MySQL pretty much across the board – hence why it’s included in the examples.</p>
</section>
<section id="practice-for-job-interviews" class="level4">
<h4 class="anchored" data-anchor-id="practice-for-job-interviews">Practice for Job Interviews</h4>
<ul>
<li><a href="https://www.hackerrank.com/products/main/">Free practice and preparation with Hackerrank.com</a></li>
<li>If you have access to DataCamp through PUBH 7461/7462 lots of SQL practice</li>
</ul>
</section>
</section>
<section id="intro-to-sql" class="level1">
<h1>1. Intro to SQL</h1>
<p>Let’s start with an anology and a simple example:</p>
<p>A <em>query</em> is to <strong>SQL</strong> as a <em>pipe</em> is to <code>dplyr</code>.</p>
<p>Recall that a pipe operator <code>%&gt;% or |&gt;</code> takes the output from the l.h.s. of the pipe and passes it as an input to the r.h.s. of the pipe. So when using a general dplyr pipeline flow, such as</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-2_79862b89bb636f1e158eef7ce4e98539">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span>                   <span class="co"># FROM df</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(var_1 <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span>  <span class="co"># WHERE var_1 &gt; 0</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">chr_var =</span> <span class="fu">as.character</span>(num_var)) <span class="sc">%&gt;%</span> <span class="co"># SELECT CAST(num_var AS CHAR)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(chr_var) <span class="sc">%&gt;%</span>  <span class="co">#GROUP BY fct_var</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(             <span class="co">#Select COUNT(*) as n, AVG(sum_var) as mean</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n    =</span> <span class="fu">n</span>(),</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(sum_var)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(chr_var, n, sum_var) <span class="co">#SELECT ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>the <em>data wrangling pipe</em> from <code>df %&gt;% $\cdots$ %&gt;% select(...)</code> is equivalent to the MySQL <em>query</em> given by</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-3_b16abbaf03afa13d342808d50ddfab60">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>SELECT chr_var, <span class="fu">COUNT</span>(<span class="sc">*</span>) AS n, mean AS <span class="fu">AVG</span>(sum_var) <span class="co">#* means all `everything()`</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">FROM</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  SELECT <span class="sc">*</span>, <span class="fu">CAST</span>(num_var AS CHAR)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  FROM df</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  WHERE var_1 <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  ) q01 <span class="co">#MySQL requires derived tables to be named </span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>GROUP BY chr_var</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>While the output and individual data wrangling steps are the same, the order of operations (<span class="math inline">\(\S 1.1\)</span>) and need for <em>derived tables</em> (<span class="math inline">\(\S 1.2\)</span>) are super different – but have no fear, once you get the hang of it translating <code>dplyr</code> back to <code>SQL</code> isn’t too bad! Fundamentally, the goal of the R pipe and SQL query is the same: <em>to wrangle data</em>. Below, we discuss the differences in syntax vs.&nbsp;execution, Q &amp; A about SQL and SQL within the R ecosystem, followed by a variety of examples for how to translating data wrangling in <code>dplyr</code> to SQL.</p>
<section id="order-of-execution-neq-syntax-order-of-sql-procedures" class="level2">
<h2 class="anchored" data-anchor-id="order-of-execution-neq-syntax-order-of-sql-procedures">1.1 Order of Execution <span class="math inline">\(\neq\)</span> Syntax Order of SQL Procedures</h2>
<section id="syntax-order-of-operations" class="level3">
<h3 class="anchored" data-anchor-id="syntax-order-of-operations">Syntax Order of Operations</h3>
<ol type="1">
<li>SELECT [ DISTINCT ] (<code>select() %&gt;% distinct()</code> / <code>mutate</code> / <code>summarise</code>)
<ul>
<li>Selects columns from table <em>AND</em> performs <code>mutate</code>/<code>summarise</code></li>
<li>AS/as for renaming, ex. SELECT var_1 * 100 AS new_var <span class="math inline">\(\iff\)</span> <code>mutate(new_var = var_1 * 100)</code></li>
<li><em>Cannot</em> access a new ‘mutated’ variable in the same SELECT where it was created
<ul>
<li>ex. <code>mutate(a = b + 1, c = a - 1)</code> <span class="math inline">\(\neq\)</span> SELECT b + 1 AS a, a - 1 AS c (won’t run)</li>
<li>See <span class="math inline">\(\S 1.2\)</span> Derived Tables below for more detail<br>
</li>
</ul></li>
</ul></li>
<li>FROM (<code>df %&gt;% .</code>)
<ul>
<li>Which table are we working with</li>
</ul></li>
<li>WHERE (<code>filter()</code>)
<ul>
<li>Remove obs. that are not of interest</li>
</ul></li>
<li>GROUP BY (<code>group_by()</code>)
<ul>
<li>Set up for group-wise summary stats</li>
<li>SQL ex. SELECT sum_var = AVG(var) FROM table GROUP BY category</li>
<li><code>dplyr</code> ex. table %&gt;% group_by(category) %&gt;% summarise(sum_var = mean(var))`</li>
<li>SELECT is used for both <code>mutate</code> and <code>summarise</code> in SQL</li>
</ul></li>
<li>HAVING (*<code>filter()</code>)
<ul>
<li>Same as <code>WHERE</code> (<code>filter</code>) but for post-grouping summaries (or just summaries <code>over()</code>)</li>
<li>However, SQLite accepts WHERE for both types of filtering</li>
</ul></li>
<li>UNION (<code>*_join()</code>)
<ul>
<li>Merging data from multiple sources by column/key</li>
<li>ex. FROM data_a as a JOIN data_b on a.key = b.key</li>
</ul></li>
<li>ORDER BY [ DESC/ASC ] (<code>arrange(desc())</code>)
<ul>
<li>No factor structure, just ordering the table layout</li>
</ul></li>
</ol>
</section>
<section id="order-of-execution" class="level3">
<h3 class="anchored" data-anchor-id="order-of-execution">Order of Execution</h3>
<ol type="1">
<li>FROM (<code>df %&gt;% .</code>)</li>
<li>WHERE (<code>filter()</code>)</li>
<li>GROUP BY (<code>group_by()</code>)</li>
<li>HAVING (another <code>filter()</code>)</li>
<li>SELECT (<code>select()</code>)</li>
<li>DISTINCT (<code>distinct()</code> retain only unique obs.)</li>
<li>UNION (<code>*_join()</code>)</li>
<li>ORDER BY [DESC/ASC] (<code>arrange(desc())</code>)</li>
</ol>
</section>
<section id="summary" class="level3">
<h3 class="anchored" data-anchor-id="summary">Summary</h3>
<p>You may have noticed that the order SQL procedures are actually run in is the same general workflow for data wrangling in R with <code>dplyr</code>, and I don’t think that’s a coincidence! SQL, born in the 70’s, is hyper efficient at what it is designed to do</p>
</section>
</section>
<section id="derived-tables" class="level2">
<h2 class="anchored" data-anchor-id="derived-tables">1.2 Derived Tables</h2>
<p>Derived tables are going to feel unnatural compared to the way we can manipulate data with <code>mutate</code> in <code>dplyr</code>, but they are necessary for more complex queries. What is a derived table you ask? Similar to piping in <code>R</code> where <code>f() %&gt;% g(.)</code> means takes the output of <code>f()</code> and passes it as an input to <code>g()</code>, when performing a series of wrangling functions like <code>filter</code>, <code>mutate</code>, <code>*_join</code>, etc. statement that pipeline is producing at least 1 derived table in the SQL translation.</p>
<p>A derived table is a subquery in a <code>FROM</code> statement which produces an intermediate table and in most SQL versions must be named with <code>AS</code>. For example this is a simple derived table/subquery –</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-4_47f8badeb5b76a27960ab2a997d2612e">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>SELECT <span class="sc">*</span> <span class="fu">FROM</span> (</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  SELECT var_1 <span class="sc">+</span> var_2 AS sum_1</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  FROM df</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>) AS tbl_1</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>WHERE sum_1 <span class="sc">&gt;</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now why do need a subquery? Why can’t we just simple say?</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-5_c859439e79e51a118169447331455a56">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>SELECT <span class="sc">*</span> FROM df <span class="fu">WHERE</span> (var_1 <span class="sc">+</span> var_2) <span class="sc">&gt;</span> <span class="dv">0</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We need a subqueries (below)!</p>
</section>
<section id="sub-queries" class="level2">
<h2 class="anchored" data-anchor-id="sub-queries">1.3 Sub-queries</h2>
<p>Very similar in syntax and flavour to derived tables, sub-queries are just derived tables which only contain <em>one column</em> and are generally used within <code>filter</code>/<code>WHERE</code>/<code>HAVING</code>. For example, in <code>R</code> we can pass data manipulations, functions, and other variables within the <code>filter</code> without thinking anything much of it –</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-6_b568b6c6c70e83c3f0e964e11735d901">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(var1 <span class="sc">&lt;</span> <span class="fu">max</span>(var2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, SQL procedures/queries don’t operate like pipes and in order to <code>mutate</code> any variable <em>AND</em> have access to it in the same procedure simultaneously, we need <em>sub-queries</em>. The MySQL sub-query equivalent to the above is given by</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-7_7458b77c013428037188e5cc4fa4e318">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>FROM df</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>WHERE var <span class="sc">&lt;</span> (SELECT <span class="fu">MAX</span>(var2) <span class="fu">OVER</span>() as max_var2 FROM df LIMIT <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, the sub-query is itself a stand alone query <em>but it must have only 1 column</em> and generally will only contain a single value/character. Example use of sub-queries in WHERE/HAVING statements is found near the end of the examples in <span class="math inline">\(\S 3\)</span>.</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-8_8f388b16f93d32f5dd23569429907a2b">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Sub-query is a valid query (1 col, 1 val)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>SELECT <span class="fu">MAX</span>(var2) <span class="fu">OVER</span>() as max_var2 <span class="co">#This is equiv. to mutate(max_var2 = max(var2))</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>FROM df <span class="co">#df %&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">1</span> <span class="co">#Only want first occurrence (it's a column of the same number)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="but-what-is-a-structured-query-language" class="level1">
<h1>2. But what <em>is</em> a Structured Query Language?</h1>
<p>How does it work, are there alternatives, and when is <code>dbplyr</code> sufficient? (Q &amp; A)</p>
<section id="q-why-procedural-instead-of-functional-or-dynamic" class="level3">
<h3 class="anchored" data-anchor-id="q-why-procedural-instead-of-functional-or-dynamic">Q: Why procedural instead of functional or dynamic?</h3>
<p><em>Answer</em> – because under the hood, SQL is actually a collection of hyper-efficient algorithms which seek to optimally complete the query you’ve requested. Since it doesn’t pull data into memory until the query is complete, this necessitates a pre-defined procedural set of instructions to be completed. This makes it less flexible but very fast!</p>
</section>
<section id="q-sql-is-super-efficient-but-what-cant-it-do" class="level3">
<h3 class="anchored" data-anchor-id="q-sql-is-super-efficient-but-what-cant-it-do">Q: SQL is super efficient, but what can’t it do?</h3>
<p><em>Answer</em> – Can’t handle non-tabular data and/or more complex data structures like lists, arrays, etc.</p>
</section>
<section id="q-are-their-alternatives-to-sql" class="level3">
<h3 class="anchored" data-anchor-id="q-are-their-alternatives-to-sql">Q: Are their alternatives to SQL?</h3>
<p><em>Answer</em> – Yes and no, it’s been around for so long that there are so many different versions and flavours of SQL that to be honest, if you are starting from square 1 it can be super confusing because fundamental syntax is slightly different between them. Kind of like how base <code>R</code> is self-consistent syntactically but individual packages, like those in the <code>tidyverse</code>, can be utterly unrecognizeable by comparison. There are also other data base languages / data structures like Apache <code>arrow</code> parquette files (in <code>R</code> it interfaces directly with <code>dplyr</code> just like <code>dbplyr</code> below), Apache Spark (<code>sparklr</code>) is another way to handle data larger than memory, and then there are also a whole suite of proprietary and open source languages for interacting with cloud databases and cloud computing (like AWS).</p>
</section>
<section id="q-if-i-know-dplyr-well-do-i-really-need-to-know-sql" class="level3">
<h3 class="anchored" data-anchor-id="q-if-i-know-dplyr-well-do-i-really-need-to-know-sql">Q: If I know <code>dplyr</code> well, do I really need to know SQL?</h3>
<p><em>Answer</em> – If you want to be a well-rounded data scientist in a production environment, or even just want to speed up your own data wrangling workflow with SQL data bases, <em>yes you need to know SQL</em> (to the point that you can use the internet to create a more complex query if you need to for work). As mentioned above, yes there are tons of ways to handle data bigger than memory without leaving the <code>R</code> ecosystem but SQL is standard in most all industrial environments.</p>
</section>
<section id="q-when-is-dbplyr-sufficient-and-when-do-i-need-to-use-sql" class="level3">
<h3 class="anchored" data-anchor-id="q-when-is-dbplyr-sufficient-and-when-do-i-need-to-use-sql">Q: When is <code>dbplyr</code> sufficient and when do I need to use SQL?</h3>
<p>While <code>dplyr</code> was surely built with SQL procedures in mind (the flow/verbs are very similar) and <code>dbplyr</code> will work for most basic to intermediate SQL queries, there’s no such thing as a free lunch. One of the biggest downsides to relying on a translator is that there are lots of data wrangling functions, workflows, and the ability to supply user defined functions almost anywhere that I use everyday in <code>R</code> but can’t use with <code>dbplyr</code> because there is no SQL equivalent. <em>However</em>, though it may not be able to generate the exact SQL query you need in a giving setting, you can certainly build a pretty comprehensive skeleton for a query with <code>show_query</code> (the syntax is also generally sub-optimal for both readability and reproducibility due to translation so copy and pasting queries is inadvisable).</p>
</section>
</section>
<section id="how-to-use-dbi-to-connect-to-db-and-dbplyr-to-generate-queries" class="level1">
<h1>3. How to use <code>DBI</code> to connect to db and <code>dbplyr</code> to generate queries</h1>
<p>In general, you don’t really use SQL locally but for practice and learning it’s best to start there. However, Creating and maintaining databases is it’s own distinct field and trying to create one locally, depending on the SQL version, can be complicated and time consuming. At work most likely experts will handle that aspect of the data pipeline, you’ll just connect and query the data you need to model, visualize, report, etc.</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-9_296ce70c91349c1ec6e0d65cf386b843">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#SQLite</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>con_sqlite <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="at">dbname =</span> <span class="st">":memory:"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">#MySQL</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>con_mysql <span class="ot">&lt;-</span> pool<span class="sc">::</span><span class="fu">dbPool</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  RMySQL<span class="sc">::</span><span class="fu">MySQL</span>(), </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">dbname =</span> <span class="st">"shinydemo"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">host =</span> <span class="st">"shiny-demo.csa7qlmguqrf.us-east-1.rds.amazonaws.com"</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">username =</span> <span class="st">"guest"</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">password =</span> <span class="st">"guest"</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">copy_to</span>(con_sqlite, nycflights13<span class="sc">::</span>flights, <span class="st">"flights"</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">temporary =</span> <span class="cn">FALSE</span>, </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">indexes =</span> <span class="fu">list</span>(</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"month"</span>, <span class="st">"day"</span>), </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"carrier"</span>, </span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tailnum"</span>,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dest"</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">copy_to</span>(con_sqlite, nycflights13<span class="sc">::</span>airports, <span class="st">"airports"</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co">#Pull table (FROM flights or FROM City)</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>flights_db <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tbl</span>(con_sqlite, <span class="st">"flights"</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>airport_db <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tbl</span>(con_sqlite, <span class="st">"airports"</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>city_db    <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tbl</span>(con_mysql, <span class="st">"City"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="lets-wrangle-some-data-examples-wexplanation" class="level1">
<h1>4. Let’s Wrangle Some Data! (Examples w/Explanation)</h1>
<section id="nyc-flights-basic-grouped-summary-stats-sqlite" class="level2">
<h2 class="anchored" data-anchor-id="nyc-flights-basic-grouped-summary-stats-sqlite">4.1 NYC Flights ‘basic’ grouped summary stats (SQLite)</h2>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/flights_db_5ad3b48478d1a224fe7b8044e4519eac">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>flights_db <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year<span class="sc">:</span>day, <span class="fu">contains</span>(<span class="st">"time"</span>), origin) <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2013</span>, day <span class="sc">&lt;</span> <span class="dv">30</span>, origin <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"LGA"</span>, <span class="st">"JFK"</span>, <span class="st">"EWR"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">dep_dif =</span> dep_tim <span class="sc">-</span> schedule_dep_time,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">arr_dif =</span> arr_time <span class="sc">-</span> sched_arr_time,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(origin) <span class="sc">%&gt;%</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_dep =</span> <span class="fu">mean</span>(dep_dif, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_arr =</span> <span class="fu">mean</span>(arr_dif, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mean_dep <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(mean_dep)) <span class="sc">%&gt;%</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT *
FROM (
  SELECT `origin`, AVG(`dep_dif`) AS `mean_dep`, AVG(`arr_dif`) AS `mean_arr`
  FROM (
    SELECT
      *,
      `dep_tim` - `schedule_dep_time` AS `dep_dif`,
      `arr_time` - `sched_arr_time` AS `arr_dif`
    FROM (
      SELECT
        `year`,
        `month`,
        `day`,
        `dep_time`,
        `sched_dep_time`,
        `arr_time`,
        `sched_arr_time`,
        `air_time`,
        `time_hour`,
        `origin`
      FROM `flights`
    )
    WHERE
      (`year` = 2013.0) AND
      (`day` &lt; 30.0) AND
      (`origin` IN ('LGA', 'JFK', 'EWR'))
  )
  GROUP BY `origin`
)
WHERE (`mean_dep` &gt; 0.0)
ORDER BY `mean_dep` DESC</code></pre>
</div>
</div>
</section>
<section id="filtering-by-the-max-and-min-city-name-by-string-length-mysql" class="level2">
<h2 class="anchored" data-anchor-id="filtering-by-the-max-and-min-city-name-by-string-length-mysql">4.2 Filtering by the max and min city name, by string length (MySQL)</h2>
<p>Consider the question “Return the min and max length city name and it’s length. Return only the first alphabetical occurance if there are multiple.”</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-10_81df49966680ccfba69da5fdccd122f2">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>city_db <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">city_len =</span> <span class="fu">length</span>(Name)) <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(city_len <span class="sc">==</span> <span class="fu">max</span>(city_len) <span class="sc">|</span> city_len <span class="sc">==</span> <span class="fu">min</span>(city_len)) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Name, city_len) <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: &lt;Pool&gt; uses an old dbplyr interface
ℹ Please install a newer version of the package or contact the maintainer
This warning is displayed once every 8 hours.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Missing values are always removed in SQL aggregation functions.
Use `na.rm = TRUE` to silence this warning
This warning is displayed once every 8 hours.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT `Name`, `city_len`
FROM (
  SELECT `ID`, `Name`, `CountryCode`, `District`, `Population`, `city_len`
  FROM (
    SELECT
      *,
      MAX(`city_len`) OVER `win1` AS `q04`,
      MIN(`city_len`) OVER `win1` AS `q05`
    FROM (
      SELECT *, length(`Name`) AS `city_len`
      FROM `City`
    ) `q01`
    WINDOW `win1` AS ()
  ) `q02`
  WHERE (`city_len` = `q04` OR `city_len` = `q05`)
) `q03`</code></pre>
</div>
</div>
<p>However, this query is a bit messy and not all verisons of SQL support WINDOW doesn’t – OVER() does seem to work fine though. Here was my solution to the question “return the min and max length city name and it’s length. Return only the first alphabetical occurance if there are multiple.” This was the solution that worked –</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-11_3fcac3304676dda0f1a5bb5b7eb85d37">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>SELECT CITY, city_len</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">FROM</span> (</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    SELECT</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>      <span class="sc">*</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">MAX</span>(city_len) <span class="fu">OVER</span>() AS max_len,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">MIN</span>(city_len) <span class="fu">OVER</span>() AS min_len</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">FROM</span> (</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>      SELECT <span class="sc">*</span>, <span class="fu">length</span>(CITY) AS city_len</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>      FROM STATION</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    ) q01</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  ) q02 </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="fu">WHERE</span> (<span class="at">city_len =</span> max_len OR <span class="at">city_len =</span> min_len)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>ORDER BY city_len DESC, CITY ASC </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>LIMIT <span class="dv">2</span> <span class="co">#Top 2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here you can’t just call max(len) or min(lin) directly in the filter/WHERE statement because they are <em>two distinct procedures in SQL</em>. Instead we need to use a WINDOW function via OVER() to obtain the aggregate max and min, have access to it later (mutate), without changing the current structure of the data (mutate vs.&nbsp;summarise).</p>
<section id="key-takeaways" class="level3">
<h3 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h3>
<ol type="1">
<li>Derived tables are necessary to access new columns (mutate) or summary/WINDOW columns</li>
<li>Continuously pass derived tables in ’reverse nesting-doll order nested fashion via SELECT</li>
<li>Generally I don’t like using arrange/ORDER BY to ensure ordering of things as it can break fairly easily if the data isn’t immaculately clean (I trust factor structure/ordinal undercoding more in general), but it seems to work here.</li>
<li>No user defined functions in SQL queries like <code>mutate(new_var = my_func(old_var))</code>, unfortunately</li>
</ol>
</section>
</section>
<section id="more-complex-group_by-summarise-in-mysql" class="level2">
<h2 class="anchored" data-anchor-id="more-complex-group_by-summarise-in-mysql">4.3 More complex group_by + summarise in (MySQL)</h2>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-12_7f356504ba96c5a972274f28935ff7e8">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>city_db <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(CountryCode <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"AFG"</span>, <span class="st">"NLD"</span>), Population <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">population_k =</span> Population <span class="sc">/</span> <span class="dv">1000</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(CountryCode, District) <span class="sc">%&gt;%</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">max =</span> <span class="fu">max</span>(population_k),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg =</span> <span class="fu">mean</span>(population_k, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span> <span class="fu">sd</span>(population_k, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(max <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Country =</span> CountryCode) <span class="sc">%&gt;%</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg)) <span class="sc">%&gt;%</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by "CountryCode". You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT `CountryCode` AS `Country`, `District`, `max`, `avg`, `var`
FROM (
  SELECT
    `CountryCode`,
    `District`,
    MAX(`population_k`) AS `max`,
    AVG(`population_k`) AS `avg`,
    POWER(STDDEV_SAMP(`population_k`), 2.0) AS `var`
  FROM (
    SELECT *, `Population` / 1000.0 AS `population_k`
    FROM `City`
    WHERE (`CountryCode` IN ('AFG', 'NLD')) AND (`Population` &gt; 1.0)
  ) `q01`
  GROUP BY `CountryCode`, `District`
) `q02`
WHERE (`max` &gt; 0.0)
ORDER BY `avg` DESC</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/summary_no_group_7a719ad49d76a37df6d5d1974415fbf0">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>city_db <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">n      =</span> <span class="fu">count</span>(CountryCode),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_dist =</span> <span class="fu">count</span>(<span class="fu">distinct</span>(CountryCode)),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_diff =</span> n <span class="sc">-</span> n_dist</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(n_diff) <span class="sc">%&gt;%</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  show_query</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT `n` - `n_dist` AS `n_diff`
FROM (
  SELECT count(`CountryCode`) AS `n`, count(distinct(`CountryCode`)) AS `n_dist`
  FROM `City`
) `q01`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># SELECT n - n_dist AS n_diff</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># FROM (</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   SELECT count(*) AS n, count(distinct(city)) AS n_dist</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   FROM STATION</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ) n_dist</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simple-regex-queries-makes-me-miss-stringr-mysql" class="level2">
<h2 class="anchored" data-anchor-id="simple-regex-queries-makes-me-miss-stringr-mysql">4.4 Simple regex queries, makes me miss <code>stringr</code>! (MySQL)</h2>
<p>Select based on starts and/or ends with –</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/regex_str_da8f2c7c560df8d0d5476b513e87585d">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>SELECT DISTINCT CITY</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>FROM   STATION</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>WHERE  CITY RLIKE <span class="st">'^[aeiouAEIOU]'</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">#IF starts AND ends with </span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="st">'^[regex].*[regex]$'</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">#If ends with </span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>.<span class="sc">*</span>[regex]<span class="sc">$</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">#DOES NOT start with</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="st">'^(?![aeiouAEIOU])'</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">#DOES NOT end with</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="st">'.*(?![aeiouAEIOU])$'</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">#DOES NOT START or DOES NOT </span><span class="re">END</span><span class="co"> WITH</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>SELECT DISTINCT city</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>FROM station</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>WHERE city NOT REGEXP <span class="st">'^[aeiou]'</span> OR city NOT REGEXP <span class="st">'[aeiou]$'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-13_5a9ec0225f03b43b77690e48c5a66394">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>SELECT NAME</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>FROM STUDENTS</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>WHERE MARKS <span class="sc">&gt;</span> <span class="dv">75</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>ORDER BY <span class="fu">RIGHT</span>(NAME, <span class="dv">3</span>), ID ASC <span class="co">#Order by last 3 chars</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="table-joins-on-table-joins-mysql" class="level2">
<h2 class="anchored" data-anchor-id="table-joins-on-table-joins-mysql">4.6 Table Joins on Table Joins (MySQL)</h2>
<section id="joining-with-no-shared-columns" class="level3">
<h3 class="anchored" data-anchor-id="joining-with-no-shared-columns">Joining with no shared columns</h3>
<p>You can combine variables from tables without an explicit join when they have no shared columns –</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-14_2b67cb471272f897f0606b6e03604583">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>SELECT <span class="sc">*</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>CASE WHEN grd.grade <span class="sc">&lt;</span> <span class="dv">8</span> THEN <span class="cn">NULL</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>     WHEN grd.grade <span class="sc">&gt;=</span> <span class="dv">8</span> THEN std.name END,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>     grd.grade, std.marks </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>FROM students std, grades grd</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>WHERE std.marks BETWEEN grd.min_mark AND grd.max_mark <span class="co"># &lt;= max &amp; &gt;= min, not equal(!) is (&lt;&gt;) in sql btw</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>ORDER BY grd.grade DESC, std.name ASC;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="joining-multiple-tables-in-a-pipequery" class="level3">
<h3 class="anchored" data-anchor-id="joining-multiple-tables-in-a-pipequery">Joining multiple tables in a pipe/query</h3>
<p>Here we need to use explicit JOIN’s and while I almost always use <code>left_join</code>, as long as you’ve placed the JOIN’s in the right order to match the relationship between the data and question of interest, just JOIN seems to be fine –</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-15_b498d53fca21062b1b756e444c921fa4">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>SELECT h.hacker_id, h.name    <span class="co">#LAST select</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>FROM Submissions AS s         <span class="co">#FIRST, data to be joined</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>JOIN Hackers AS h             <span class="co">#Join with hacker data by hacker id</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  on s.hacker_id <span class="ot">=</span> h.hacker_id </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>JOIN Challenges as c          <span class="co">#Join with challenge data on challenge id</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  on s.challenge_id <span class="ot">=</span> c.challenge_id</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>JOIN Difficulty as d          <span class="co">#Join with difficulty on Difficulty_level </span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  on c.Difficulty_level <span class="ot">=</span> d.Difficulty_level</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>WHERE s.score <span class="ot">=</span> d.score             <span class="co">#Max score </span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>GROUP BY h.hacker_id, h.name        <span class="co">#group_by id and name</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>HAVING <span class="fu">count</span>(<span class="sc">*</span>) <span class="sc">&gt;</span> <span class="dv">1</span>                 <span class="co">#WHERE but for summarise</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>ORDER BY <span class="fu">count</span>(<span class="sc">*</span>) DESC, h.hacker_id <span class="co">#arrange</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And here’s the <code>dplyr</code> pipe translation of that SQL query –</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-16_e21bbd677ac587d936cfd6380bb5860c">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>submission.df <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(., hacker.df,     <span class="at">by =</span> <span class="st">"hacker_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(., challenge.df,  <span class="at">by =</span> <span class="st">"challenge_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(., difficulty.df, <span class="at">by =</span> <span class="st">"Difficulty_level"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="at">x.score =</span> y.score) <span class="sc">%&gt;%</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hacker_id, name) <span class="sc">%&gt;%</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n), hacker_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="more-complicated-table-joins-and-queries-and-one-sub-query" class="level3">
<h3 class="anchored" data-anchor-id="more-complicated-table-joins-and-queries-and-one-sub-query">More complicated table joins and queries (and one sub-query!)</h3>
<p>Here we’re joining a few tables to answer a more complicated question, which will require us to employ a sub-query to get the reproducible <code>filter</code>/WHERE statement we need at the end. In <code>R</code>, we don’t need sub-queries because we can simply perform a 2-step process: (1) run the sub-query or pipe prior and store the result as a variable in our global/local env and (2) pass that variable through the <code>filter</code>/WHERE procedure in the main query/pipe.</p>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-17_38c605f0b30f03c0827b09aedd1026a4">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>SELECT w.id, p.age, w.coins_needed, w.power</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>FROM Wands AS w </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>JOIN Wands_Property AS p <span class="co"># Join</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    ON w.code <span class="ot">=</span> p.code</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>WHERE w.coins_needed <span class="ot">=</span> (SELECT <span class="fu">min</span>(coins_needed) <span class="co">#Filter by sub-query </span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                        FROM Wands w2            <span class="co">#From wand data</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                        INNER JOIN Wands_Property p2 <span class="co">#Inner join by wand property (join then filter missing)</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>                          ON <span class="at">w2.code =</span> p2.code   <span class="co">#Conditions below pertain to the specific question</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>                        WHERE <span class="at">p2.is_evil =</span> <span class="dv">0</span> AND <span class="at">p.age =</span> p2.age AND <span class="at">w.power =</span> w2.power)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>ORDER BY w.power DESC, p.age DESC;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a-join-and-two-sub-queries" class="level3">
<h3 class="anchored" data-anchor-id="a-join-and-two-sub-queries">A join and two sub-queries</h3>
<div class="cell" data-layout-align="center" data-hash="dbplyr_sql_cache/html/unnamed-chunk-18_882f7aefaca4590bfe9a804d52483274">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>SELECT c.hacker_id, h.name, <span class="fu">count</span>(c.challenge_id) AS cnt </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>FROM Hackers AS h</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>JOIN Challenges AS c </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  ON h.hacker_id <span class="ot">=</span> c.hacker_id</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>GROUP BY c.hacker_id, h.name </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>HAVING cnt <span class="ot">=</span> (SELECT <span class="fu">count</span>(c1.challenge_id) </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>              FROM Challenges AS c1</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>              GROUP BY c1.hacker_id </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>              ORDER BY <span class="fu">count</span>(<span class="sc">*</span>) desc limit <span class="dv">1</span>) OR</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>       cnt NOT <span class="fu">IN</span> (SELECT <span class="fu">count</span>(c2.challenge_id)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>              FROM Challenges AS c2 </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>              GROUP BY c2.hacker_id </span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>              HAVING c2.hacker_id <span class="sc">&lt;</span><span class="er">&gt;</span> c.hacker_id) <span class="co">#not equal to (&lt;&gt;)</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>ORDER BY cnt DESC, c.hacker_id;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022 | QN</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="http://github.com/nevilleq/">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/quinton-neville/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:<nevil066@umn.edu>">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>